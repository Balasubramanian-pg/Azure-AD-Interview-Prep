# [SAML SSO Flow](03 Single Sign-On/SAML SSO Flow.md)

Canonical documentation for [SAML SSO Flow](03 Single Sign-On/SAML SSO Flow.md). This document defines concepts, terminology, and standard usage.

## Purpose
The Security Assertion Markup Language (SAML) Single Sign-On (SSO) flow exists to facilitate federated identity management. It addresses the problem of fragmented user identities across disparate systems by allowing a centralized Identity Provider (IdP) to vouch for a user's identity to multiple Service Providers (SPs). This eliminates the need for users to maintain separate credentials for every application and allows organizations to centralize authentication logic, security policies, and session management.

> [!NOTE]
> This documentation is intended to be implementation-agnostic and authoritative.

## Scope
Clarify what is in scope and out of scope for this topic.

**In scope:**
* The exchange of XML-based authentication and authorization data.
* Roles of the Identity Provider (IdP) and Service Provider (SP).
* Standard protocol bindings (Redirect, POST).
* The lifecycle of a SAML assertion during a login event.
* Security mechanisms inherent to the protocol (Digital Signatures, Encryption).

**Out of scope:**
* Specific vendor implementations (e.g., Okta, Azure AD, Shibboleth).
* Provisioning protocols (e.g., SCIM).
* Non-SAML federation protocols (e.g., OIDC, [WS-Fed](03 Single Sign-On/WS-Fed.md)eration).

## Definitions
Provide precise definitions for key terms.

| Term | Definition |
|------|------------|
| Identity Provider (IdP) | The entity that authenticates the principal and issues SAML assertions. |
| Service Provider (SP) | The entity (application) that provides the service and relies on assertions from the IdP to grant access. |
| Assertion | An XML document issued by an IdP that contains statements about a userâ€™s identity and attributes. |
| Assertion Consumer Service (ACS) | The endpoint on the SP that receives and processes the SAML Response from the IdP. |
| AuthnRequest | The XML message sent by the SP to the IdP to initiate the authentication process. |
| Binding | The mechanism by which SAML messages are transported (e.g., HTTP Redirect, HTTP POST). |
| Metadata | An XML file exchanged between IdP and SP containing configuration details, such as endpoints and public keys. |
| Principal | The entity (usually a human user) whose identity is being authenticated. |
| RelayState | A parameter used to maintain state information across the SSO flow, often used to redirect users back to their original destination. |

## Core Concepts
The SAML SSO flow is built upon three fundamental pillars:

1.  **Trust Relationship:** Before any flow can occur, the IdP and SP must establish a trust relationship. This is achieved by exchanging Metadata files containing public certificates and endpoint URLs.
2.  **XML-Based Assertions:** SAML uses structured XML to convey identity information. These assertions are digitally signed (and optionally encrypted) to ensure integrity and confidentiality.
3.  **Browser-Based Redirection:** The protocol relies on the user's browser (the "User Agent") to act as the intermediary. The IdP and SP do not typically communicate directly; instead, they pass messages through the browser via redirects or form posts.

## Standard Model
The standard model for SAML SSO is the **SP-Initiated Flow**, which follows these sequential steps:

1.  **Access Attempt:** The Principal attempts to access a protected resource on the Service Provider.
2.  **AuthnRequest Generation:** The SP determines which IdP to use, generates a `<samlp:AuthnRequest>`, and signs it (optional but recommended).
3.  **Redirection to IdP:** The SP sends the AuthnRequest to the Principal's browser, which redirects the Principal to the IdP's Single Sign-On URL (usually via HTTP Redirect Binding).
4.  **Authentication:** The IdP identifies the Principal (e.g., via username/password, MFA, or existing session).
5.  **SAML Response Generation:** Upon successful authentication, the IdP generates a `<samlp:Response>` containing a signed `<saml:Assertion>`.
6.  **Assertion Delivery:** The IdP sends the Response to the Principal's browser, which automatically submits it to the SP's Assertion Consumer Service (ACS) URL (usually via HTTP POST Binding).
7.  **Validation:** The SP validates the digital signature, checks the assertion's validity period (`NotBefore` and `NotOnOrAfter`), and ensures the `InResponseTo` ID matches the original request.
8.  **Access Granted:** The SP establishes a local session for the Principal and redirects them to the requested resource.

## Common Patterns

### IdP-Initiated Flow
In this pattern, the Principal starts at the IdP's dashboard (e.g., an "App Portal"). The IdP generates a SAML Response for a specific SP and sends it to the browser to be posted to the SP's ACS URL. No `AuthnRequest` is generated by the SP.

### HTTP Redirect Binding
Used primarily for the `AuthnRequest`. The SAML message is URL-encoded and appended as a query parameter. Due to URL length limits, this is rarely used for the much larger SAML Response.

### HTTP POST Binding
Used primarily for the SAML Response. The XML message is base64-encoded and placed within an HTML form field, which is automatically submitted to the destination via JavaScript.

## Anti-Patterns

*   **Insecure Signature Validation:** Failing to verify the digital signature against the trusted certificate in the Metadata. This allows attackers to forge assertions.
*   **Ignoring Validity Windows:** Failing to enforce `NotBefore` and `NotOnOrAfter` timestamps, which increases the risk of replay attacks.
*   **Hardcoding Metadata:** Manually entering endpoints and certificates instead of consuming a dynamic Metadata URL. This leads to service outages when certificates expire.
*   **Using SAML for Authorization:** Relying solely on the presence of an assertion to grant high-level permissions without checking specific attributes or internal RBAC logic.
*   **Lack of `InResponseTo` Verification:** In SP-initiated flows, failing to correlate the Response with a known, pending Request ID.

## Edge Cases

*   **Clock Skew:** Differences in system time between the IdP and SP can cause valid assertions to be rejected. A "skew" allowance (typically 3-5 minutes) is usually implemented.
*   **Single Log-Out (SLO):** The complexity of terminating sessions across all SPs when a user logs out of the IdP. This is often unreliable due to browser cookie restrictions and network failures.
*   **Multiple IdPs:** When an SP must support users from different organizations, it must implement a "Discovery Service" or "WAYF" (Where Are You From) screen to determine which IdP to redirect to.
*   **Large Assertions:** Assertions containing hundreds of group memberships may exceed the maximum size for HTTP POST requests or cause performance issues during XML parsing.

## Related Topics
*   **[OAuth 2.0](03 Single Sign-On/OAuth 2.0.md) / OpenID Connect (OIDC):** Modern alternatives to SAML, often preferred for mobile and API-centric environments.
*   **Public Key Infrastructure (PKI):** The underlying system of certificates and keys used to sign SAML messages.
*   **XML Signature (XMLDSig):** The specific standard used for signing SAML assertions.
*   **Identity Federation:** The broader concept of linking a user's identity across multiple security domains.

## Change Log
| Version | Date | Description |
|---------|------|-------------|
| 1.0 | 2026-01-20 | Initial AI-generated canonical documentation |